#+title: Final Assignment's Labbook
#+author: Henrique Silva
#+email: hcpsilva@inf.ufrgs.br
#+infojs_opt:
#+property: session *R*
#+property: cache yes
#+property: results graphics
#+property: exports both
#+property: tangle yes

Welcome to this project's lab-book! Here I'll organize my thoughts and perhaps
put my scripts and so on and so forth.

As you may know, in this assignment we're expected to implement one or more
modules of a processor that's being simulated:

- *Prefetcher*
- *Cache substitution policy*
- *Branch predictor*

As of now we are still considering the options as of which of those we should
implement.

* Table of contents                                                   :TOC_3:
- [[#journal][Journal]]
  - [[#2019-12-25][2019-12-25]]
- [[#experiments][Experiments]]
  - [[#1---base-processors][1 - Base processors]]
    - [[#preprocessing][Preprocessing]]
    - [[#analysis][Analysis]]
  - [[#2---instruction-prefetcher][2 - Instruction Prefetcher]]
    - [[#preprocessing-1][Preprocessing]]
    - [[#analysis-1][Analysis]]
  - [[#3---data-prefetcher][3 - Data Prefetcher]]
    - [[#preprocessing-2][Preprocessing]]
    - [[#analysis-2][Analysis]]
  - [[#4---greedier-data-prefetcher][4 - Greedier Data Prefetcher]]
    - [[#preprocessing-3][Preprocessing]]
    - [[#analysis-3][Analysis]]
  - [[#5---64-lines-l1d-prefetcher][5 - 64 lines L1D Prefetcher]]
    - [[#preprocessing-4][Preprocessing]]
    - [[#analysis-4][Analysis]]
  - [[#6---stream-on-instructions][6 - Stream on Instructions]]
    - [[#preprocessing-5][Preprocessing]]
    - [[#analysis-5][Analysis]]
  - [[#7---32-line-l1d-prefetcher][7 - 32 line L1D Prefetcher]]
    - [[#preprocessing-6][Preprocessing]]
    - [[#analysis-6][Analysis]]

* Journal

Thoughts and stuff.

** 2019-12-25

Merry Christmas I guess. So, we've got a preliminary list of what applications
to test, which is always useful, but still no idea of which element to
implement. Here's an excerpt:

#+begin_quote
- bzip2 :: integer. Imagino que compressão tenha um padrão de acesso aos dados
           contíguo e regular. Desse modo, com um prefetcher stream a gente
           consegue tirar mais proveito do que com um prefetcher strided por
           ex. Ainda mostraria como qualquer algoritmo de substituição não seria
           lá muito eficiente. Checar com Francis.
- gcc :: Acessos bem irregulares pros quais é difícil acertar qualquer
         coisa. Also é importante lembrar que haverá melhoras de uma
         configuração pra outra por conta da evolução dos branch predictors
         escolhidos.
- astar :: integer. Algoritmos de path finding em ambiente 2D.
- povray :: ray tracing. Normalmente OO, o que torna o acesso à mem
            interessante.  Also: iterações pelos objetos a cada pulo, teste de
            intersecção: branch predictor.
- calculix :: matrizes esparsas pra resolver equações diferenciais. Matrizes
              esparsas.
#+end_quote

I mean, I've got no idea of what benchmarks exercise the different parts of the
processor, so I'm all for it. As far as the simulator goes, I'll try to figure
out how it works. Time to read that convoluted =readme=...

So, I've understood how it works (because it's really easy to build and run
stuff). Thing is, I have absolutely no idea on how to implement the stuff
mentioned previously (the new policies, etc). Like, really no idea. I took a
look at all the modules we could implement, but they're really not that easy to
understand, which may have something to do with the fact that I don't know this
architecture stuff in the first place. And I'm kinda traumatized to go search in
those terrible slides because of my previous experiences.

I doubt that this simulator has seen some use in the academy, but I'll go look
for something anyways...

Well, I'll be damned! Here are some links:

- [[https://arxiv.org/pdf/1906.00877.pdf]]
- [[http://nope.pub/papers/2017/gomes2017watermarking.pdf]]
- [[https://www.usenix.org/system/files/woot19-paper_kumar.pdf]]

There are more, but the point was made. I think those are a bit overkill for a
simple uni assignment, because all of them verse about some really
state-of-the-art stuff. I'm thinking about finding some novel approach proposed
in the 80s-90s and implementing it, as these ought to be significantly simpler
than the ones I've collected.

Besides that stuff, I'm looking forward into having access to the report so I
can use the IEEE template.

* Experiments

Home to experiment-related scripts.

As defined in the specification of this assignment, all simulations will be
single-core, even though the simulator supports multi-core. So, as interference
isn't an issue, I'm thinking of launching as many executions as I can. This
would speed up the experiments significantly, but would imply in multiple copies
of the repo.

** 1 - Base processors                                               :EXP01:

The simplest of the bunch:

#+begin_example
Branch Predictor: bimodal
L1D Prefetcher: no
L1I Prefetcher: no
L2C Prefetcher: no
LLC Prefetcher: no
LLC Replacement: lru
Cores: 1
#+end_example

The "almost there" of the bunch:

#+begin_example
Branch Predictor: bimodal
L1D Prefetcher: next_line
L1I Prefetcher: next_line
L2C Prefetcher: ip_stride
LLC Prefetcher: no
LLC Replacement: lru
Cores: 1
#+end_example

The fastest of the bunch:

#+begin_example
Branch Predictor: hashed_perceptron
L1D Prefetcher: next_line
L1I Prefetcher: next_line
L2C Prefetcher: kpcp
LLC Prefetcher: next_line
LLC Replacement: drrip
Cores: 1
#+end_example

*** Preprocessing

In order to analyze the data, we must parse the output files to a more friendly
=csv= format.

#+begin_src bash :exports both :results output :dir ../results_base/
OUT_FILE=base_results.csv

echo "application,size,branch,l1i_pref,l1d_pref,l2c_pref,llc_pref,llc_rep,inst,cycles,ipc"\
     "l1i_tot_hit,l1i_tot_miss,l1i_pref_issued,l1i_pref_useful,l1i_pref_useless,l1i_lat"\
     "l1d_tot_hit,l1d_tot_miss,l1d_pref_issued,l1d_pref_useful,l1d_pref_useless,l1d_lat"\
     "l2c_tot_hit,l2c_tot_miss,l2c_pref_issued,l2c_pref_useful,l2c_pref_useless,l2c_lat"\
     "llc_tot_hit,llc_tot_miss,llc_pref_issued,llc_pref_useful,llc_pref_useless,llc_lat"\
     "branch_acc,mpki"\
     "branch_direct,branch_indirect,branch_cond,branch_dir_call,branch_ind_call,branch_ret" | tr ' ' ',' > $OUT_FILE

for file in [0-9]*; do
    # INFO ABOUT CONFIG

    buffer=$(tr '-' ' ' <<<$file)

    app=$(awk '{print $1}' <<<$buffer)
    size=$(awk '{print $2}' <<<$buffer)
    branch=$(awk '{print $3}' <<<$buffer)
    l1i_p=$(awk '{print $4}' <<<$buffer)
    l1d_p=$(awk '{print $5}' <<<$buffer)
    l2_p=$(awk '{print $6}' <<<$buffer)
    llc_p=$(awk '{print $7}' <<<$buffer)
    llc_repl=$(awk '{print $8}' <<<$buffer)

    line=${app##*.},${size%%.*},${branch},${l1i_p},${l1d_p},${l2_p},${llc_p},${llc_repl},

    # GENERAL INFO

    buffer=$(grep "CPU 0 cumulative" $file)
    insts=$(awk '{print $7}' <<<$buffer)
    cycles=$(awk '{print $9}' <<<$buffer)
    ipc=$(awk '{print $5}' <<<$buffer)

    line+=${insts},${cycles},${ipc},

    # LEVEL 1 INST

    buffer=$(grep "L1I TOTAL" $file)
    l1i_hit=$(awk '{print $6}' <<<$buffer)
    l1i_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1i_hit},${l1i_miss},

    buffer=$(grep "L1I PREFETCH  REQUESTED:" $file)
    l1i_iss=$(awk '{print $6}' <<<$buffer)
    l1i_usef=$(awk '{print $8}' <<<$buffer)
    l1i_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1i_iss},${l1i_usef},${l1i_less},

    buffer=$(grep "L1I AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 1 DATA

    buffer=$(grep "L1D TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L1D PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L1D AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 2 CACHE

    buffer=$(grep "L2C TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L2C PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L2C AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LAST LEVEL CACHE

    buffer=$(grep "LLC TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "LLC PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "LLC AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # BRANCH PREDICTION

    buffer=$(grep "CPU 0 Branch Prediction" $file)

    branch_acc=$(awk '{print $6}' <<<$buffer | tr -d '%')
    mpki=$(awk '{print $8}' <<<$buffer)

    line+=${branch_acc},${mpki},

    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_JUMP:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_CONDITIONAL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_RETURN:" $file) | tr -d '%')

    echo $line >> $OUT_FILE
    echo "finished this line, yay!"
done

echo "i'm done!"
#+end_src

#+RESULTS:
#+begin_example
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
i'm done!
#+end_example

*** Analysis

Let's explore this data...

#+begin_src R :session :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)

df <- read_csv("../results_base/base_results.csv")
#+end_src

#+RESULTS:
#+begin_example

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.
#+end_example

Okay, let's compare the IPC then:

#+begin_src R :session :results output graphics :file images/base/ipc.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, ipc) %>%
  ggplot(aes(fill = l2c_pref, y = ipc, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Simples", "Mediana", "Avançada")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Instruções Por Ciclo",
       fill = "Configuração",
       title = "IPC conforme configuração",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/ipc.png]]

Cool. Let's look at something more interesting.

#+begin_src R :session :results output graphics :file images/base/hitmiss_l1d_log.png :exports both :width 1200 :height 600
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l1d_tot_hit) %>%
  mutate(stat = "hit") %>%
  rename(value = l1d_tot_hit) -> dfh

df %>%
  select(application, l2c_pref, l1d_tot_miss) %>%
  mutate(stat = "miss") %>%
  rename(value = l1d_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  ggplot(aes(fill = stat, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Hit", "Miss")) +
  scale_y_log10(
    expand = expand_scale(mult = c(0, 0.03)),
    breaks = scales::trans_breaks(n = 8, "log10", function(x) 10^x),
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  annotation_logticks(sides = "lr") +
  facet_grid(. ~ l2c_pref) +
  labs(x = "Aplicação",
       y = "Quantidade (log10)",
       fill = "Acesso à cache nível 1 de dados") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/hitmiss_l1d_log.png]]

Now grouping in another way...

#+begin_src R :session :results output graphics :file images/base/hitmiss_l1d.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l1d_tot_hit) %>%
  mutate(stat = "Hit", l1d_tot_hit = l1d_tot_hit / 1000000) %>%
  rename(value = l1d_tot_hit) -> dfh

df %>%
  select(application, l2c_pref, l1d_tot_miss) %>%
  mutate(stat = "Miss", l1d_tot_miss = l1d_tot_miss / 1000000) %>%
  rename(value = l1d_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  ggplot(aes(fill = l2c_pref, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Simples", "Médio", "Avançado")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Acesso à cache nível 1 de dados",
       title = "Quantidade de acessos à cache nível 1 de dados",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/hitmiss_l1d.png]]

Now let's see some relative misses...

#+begin_src R :session :results output graphics :file images/base/relmiss_l1d.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l1d_tot_hit, l1d_tot_miss) %>%
  mutate(stat = "L1D", value = l1d_tot_miss / l1d_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfl1

df %>%
  select(application, l2c_pref, l2c_tot_hit, l2c_tot_miss) %>%
  mutate(stat = "L2C", value = l2c_tot_miss / l2c_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfl2

df %>%
  select(application, l2c_pref, llc_tot_hit, llc_tot_miss) %>%
  mutate(stat = "LLC", value = llc_tot_miss / llc_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfll

df2 <- dfl1

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  ggplot(aes(fill = l2c_pref, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Simples", "Médio", "Avançado")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L1D",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/relmiss_l1d.png]]

#+begin_src R :session :results output graphics :file images/base/relmiss_l2c.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l1d_tot_hit, l1d_tot_miss) %>%
  mutate(stat = "L1D", value = l1d_tot_miss / l1d_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfl1

df %>%
  select(application, l2c_pref, l2c_tot_hit, l2c_tot_miss) %>%
  mutate(stat = "L2C", value = l2c_tot_miss / l2c_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfl2

df %>%
  select(application, l2c_pref, llc_tot_hit, llc_tot_miss) %>%
  mutate(stat = "LLC", value = llc_tot_miss / llc_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfll

df2 <- dfl2

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  ggplot(aes(fill = l2c_pref, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Simples", "Médio", "Avançado")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L2C",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/relmiss_l2c.png]]

#+begin_src R :session :results output graphics :file images/base/relmiss_llc.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l1d_tot_hit, l1d_tot_miss) %>%
  mutate(stat = "L1D", value = l1d_tot_miss / l1d_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfl1

df %>%
  select(application, l2c_pref, l2c_tot_hit, l2c_tot_miss) %>%
  mutate(stat = "L2C", value = l2c_tot_miss / l2c_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfl2

df %>%
  select(application, l2c_pref, llc_tot_hit, llc_tot_miss) %>%
  mutate(stat = "LLC", value = llc_tot_miss / llc_tot_hit) %>%
  select(application, l2c_pref, stat, value) -> dfll

df2 <- dfll

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  ggplot(aes(fill = l2c_pref, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Simples", "Médio", "Avançado")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "configuração",
       title = "Misses relativos na LLC",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/relmiss_llc.png]]

Nice, now MPKI...

#+begin_src R :session :results output graphics :file images/base/mpki.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l1d_tot_miss, l2c_tot_miss, llc_tot_miss, inst) %>%
  mutate(mpki = (l1d_tot_miss + l2c_tot_miss + llc_tot_miss) * 1000 / inst) %>%
  ggplot(aes(fill = l2c_pref, y = mpki, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Simples", "Mediana", "Avançada")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "MPKI",
       fill = "Configuração",
       title = "MPKI conforme configuração",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/mpki.png]]

I think it'd be cool to see the useful vs useless prefetchs...

#+begin_src R :session :results output graphics :file images/base/useful_l1d.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l1d_pref_useful) %>%
  mutate(stat = "Úteis", l1d_pref_useful = l1d_pref_useful / 100000) %>%
  rename(value = l1d_pref_useful) -> dfh

df %>%
  select(application, l2c_pref, l1d_pref_useless) %>%
  mutate(stat = "Inúteis", l1d_pref_useless = l1d_pref_useless / 100000) %>%
  rename(value = l1d_pref_useless) -> dfm

df2 <- bind_rows(dfh, dfm)

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  filter(l2c_pref != "Simples") %>%
  ggplot(aes(fill = l2c_pref, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Médio", "Avançado")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^5]",
       fill = "Configuração utilizada",
       title = "Utilidade dos prefetchs realizados na L1D",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/useful_l1d.png]]

#+begin_src R :session :results output graphics :file images/base/useful_l2c.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, l2c_pref_useful) %>%
  mutate(stat = "Úteis", l2c_pref_useful = l2c_pref_useful / 100000) %>%
  rename(value = l2c_pref_useful) -> dfh

df %>%
  select(application, l2c_pref, l2c_pref_useless) %>%
  mutate(stat = "Inúteis", l2c_pref_useless = l2c_pref_useless / 100000) %>%
  rename(value = l2c_pref_useless) -> dfm

df2 <- bind_rows(dfh, dfm)

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  filter(l2c_pref != "Simples") %>%
  ggplot(aes(fill = l2c_pref, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Médio", "Avançado")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^5]",
       fill = "Configuração utilizada",
       title = "Utilidade dos prefetchs realizados na L2C",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/useful_l2c.png]]

#+begin_src R :session :results output graphics :file images/base/useful_llc.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df$l2c_pref <- factor(df$l2c_pref, levels = c("no", "ip_stride", "kpcp"))

df %>%
  select(application, l2c_pref, llc_pref_useful) %>%
  mutate(stat = "Úteis", llc_pref_useful = llc_pref_useful / 100000) %>%
  rename(value = llc_pref_useful) -> dfh

df %>%
  select(application, l2c_pref, llc_pref_useless) %>%
  mutate(stat = "Inúteis", llc_pref_useless = llc_pref_useless / 100000) %>%
  rename(value = llc_pref_useless) -> dfm

df2 <- bind_rows(dfh, dfm)

levels(df2$l2c_pref) <- c("Simples", "Médio", "Avançado")

df2 %>%
  filter(l2c_pref != "Simples") %>%
  ggplot(aes(fill = l2c_pref, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 3, name = "GrandBudapest1"),
                    labels = c("Médio", "Avançado")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^5]",
       fill = "Configuração utilizada",
       title = "Utilidade dos prefetchs realizados na LLC",
       subtitle = "para o primeiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/base/useful_llc.png]]

** 2 - Instruction Prefetcher                                        :EXP02:

Realized with the modified =next_line2= for the L1I.

#+begin_example
Branch Predictor: bimodal
L1D Prefetcher: next_line
L1I Prefetcher: next_line
L2C Prefetcher: no
LLC Prefetcher: no
LLC Replacement: lru
Cores: 1
#+end_example

*** Preprocessing

Again, a script...

#+begin_src bash :exports both :results output :dir ../results_test/
OUT_FILE=test_results.csv

echo "application,size,branch,l1i_pref,l1d_pref,l2c_pref,llc_pref,llc_rep,inst,cycles,ipc"\
     "l1i_tot_hit,l1i_tot_miss,l1i_pref_issued,l1i_pref_useful,l1i_pref_useless,l1i_lat"\
     "l1d_tot_hit,l1d_tot_miss,l1d_pref_issued,l1d_pref_useful,l1d_pref_useless,l1d_lat"\
     "l2c_tot_hit,l2c_tot_miss,l2c_pref_issued,l2c_pref_useful,l2c_pref_useless,l2c_lat"\
     "llc_tot_hit,llc_tot_miss,llc_pref_issued,llc_pref_useful,llc_pref_useless,llc_lat"\
     "branch_acc,mpki"\
     "branch_direct,branch_indirect,branch_cond,branch_dir_call,branch_ind_call,branch_ret" | tr ' ' ',' > $OUT_FILE

for file in [0-9]*; do
    # INFO ABOUT CONFIG

    buffer=$(tr '-' ' ' <<<$file)

    app=$(awk '{print $1}' <<<$buffer)
    size=$(awk '{print $2}' <<<$buffer)
    branch=$(awk '{print $3}' <<<$buffer)
    l1i_p=$(awk '{print $4}' <<<$buffer)
    l1d_p=$(awk '{print $5}' <<<$buffer)
    l2_p=$(awk '{print $6}' <<<$buffer)
    llc_p=$(awk '{print $7}' <<<$buffer)
    llc_repl=$(awk '{print $8}' <<<$buffer)

    line=${app##*.},${size%%.*},${branch},${l1i_p},${l1d_p},${l2_p},${llc_p},${llc_repl},

    # GENERAL INFO

    buffer=$(grep "CPU 0 cumulative" $file)
    insts=$(awk '{print $7}' <<<$buffer)
    cycles=$(awk '{print $9}' <<<$buffer)
    ipc=$(awk '{print $5}' <<<$buffer)

    line+=${insts},${cycles},${ipc},

    # LEVEL 1 INST

    buffer=$(grep "L1I TOTAL" $file)
    l1i_hit=$(awk '{print $6}' <<<$buffer)
    l1i_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1i_hit},${l1i_miss},

    buffer=$(grep "L1I PREFETCH  REQUESTED:" $file)
    l1i_iss=$(awk '{print $6}' <<<$buffer)
    l1i_usef=$(awk '{print $8}' <<<$buffer)
    l1i_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1i_iss},${l1i_usef},${l1i_less},

    buffer=$(grep "L1I AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 1 DATA

    buffer=$(grep "L1D TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L1D PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L1D AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 2 CACHE

    buffer=$(grep "L2C TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L2C PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L2C AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LAST LEVEL CACHE

    buffer=$(grep "LLC TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "LLC PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "LLC AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # BRANCH PREDICTION

    buffer=$(grep "CPU 0 Branch Prediction" $file)

    branch_acc=$(awk '{print $6}' <<<$buffer | tr -d '%')
    mpki=$(awk '{print $8}' <<<$buffer)

    line+=${branch_acc},${mpki},

    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_JUMP:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_CONDITIONAL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_RETURN:" $file) | tr -d '%')

    echo $line >> $OUT_FILE
    echo "finished this line, yay!"
done

echo "i'm done!"
#+end_src

#+RESULTS:
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: i'm done!

*** Analysis

Let's start by uniting both base and own results...

#+begin_src R :session :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)

df_b <- read_csv("../results_base/base_results.csv")
df_t <- read_csv("../results_test/test_results.csv") %>%
  mutate(config = "Própria")

basic <- df_b %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples")

medium <- df_b %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana")

adv <- df_b %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada")

df_b <- bind_rows(basic, medium, adv)

df <- bind_rows(df_b, df_t)
#+end_src

#+RESULTS:
#+begin_example

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.
#+end_example

And now let's take the already done EXP03 graphs.

#+begin_src R :session :results output graphics :file images/test/ipc.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df %>%
  select(application, config, ipc) %>%
  ggplot(aes(fill = as.factor(config), y = ipc, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Instruções Por Ciclo",
       fill = "Configuração",
       title = "IPC conforme configuração",
       subtitle = "para o segundo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/test/ipc.png]]

Now, let's do MPKI by hand (for L1I):

#+begin_src R :session :results output graphics :file images/test/mpki_hand.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df %>%
  select(application, config, l1i_tot_miss, inst) %>%
  mutate(mpki = l1i_tot_miss / (inst / 1000)) %>%
  ggplot(aes(fill = as.factor(config), y = mpki, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "MPKI",
       fill = "Configuração",
       title = "MPKI conforme configuração",
       subtitle = "na L1I para o segundo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/test/mpki_hand.png]]

Now some hit and misses metrics for L1I:

#+begin_src R :session :results output graphics :file images/test/hitmiss_l1i.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1i_tot_hit) %>%
  mutate(stat = "Hit", l1i_tot_hit = l1i_tot_hit / 1000000) %>%
  rename(value = l1i_tot_hit) -> dfh

df %>%
  select(application, config, l1i_tot_miss) %>%
  mutate(stat = "Miss", l1i_tot_miss = l1i_tot_miss / 1000000) %>%
  rename(value = l1i_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

df2$config <- factor(df2$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df2 %>%
  ggplot(aes(fill = as.factor(config), y = value, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Configuração",
       title = "Acessos à cache nível 1 de instruções",
       subtitle = "conforme hit ou miss para o segundo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/test/hitmiss_l1i.png]]

And relative misses...

#+begin_src R :session :results output graphics :file images/test/relmiss_l1i.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1i_tot_hit, l1i_tot_miss) %>%
  mutate(stat = "L1I", value = l1i_tot_miss / l1i_tot_hit) %>%
  select(application, config, stat, value) -> df2

df2$config <- factor(df2$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df2 %>%
  ggplot(aes(fill = config, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L1I",
       subtitle = "para o segundo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/test/relmiss_l1i.png]]

** 3 - Data Prefetcher                                               :EXP03:

#+begin_example
Branch Predictor: bimodal
L1D Prefetcher: next_line2
L1I Prefetcher: next_line
L2C Prefetcher: no
LLC Prefetcher: no
LLC Replacement: lru
Cores: 1
#+end_example

*** Preprocessing

First we gotta get that into a friendlier CSV format...

#+begin_src bash :exports both :results output :dir ../results_stream/
OUT_FILE=stream_results.csv

echo "application,size,branch,l1i_pref,l1d_pref,l2c_pref,llc_pref,llc_rep,inst,cycles,ipc"\
     "l1i_tot_hit,l1i_tot_miss,l1i_pref_issued,l1i_pref_useful,l1i_pref_useless,l1i_lat"\
     "l1d_tot_hit,l1d_tot_miss,l1d_pref_issued,l1d_pref_useful,l1d_pref_useless,l1d_lat"\
     "l2c_tot_hit,l2c_tot_miss,l2c_pref_issued,l2c_pref_useful,l2c_pref_useless,l2c_lat"\
     "llc_tot_hit,llc_tot_miss,llc_pref_issued,llc_pref_useful,llc_pref_useless,llc_lat"\
     "branch_acc,mpki"\
     "branch_direct,branch_indirect,branch_cond,branch_dir_call,branch_ind_call,branch_ret" | tr ' ' ',' > $OUT_FILE

for file in [0-9]*; do
    # INFO ABOUT CONFIG

    buffer=$(tr '-' ' ' <<<$file)

    app=$(awk '{print $1}' <<<$buffer)
    size=$(awk '{print $2}' <<<$buffer)
    branch=$(awk '{print $3}' <<<$buffer)
    l1i_p=$(awk '{print $4}' <<<$buffer)
    l1d_p=$(awk '{print $5}' <<<$buffer)
    l2_p=$(awk '{print $6}' <<<$buffer)
    llc_p=$(awk '{print $7}' <<<$buffer)
    llc_repl=$(awk '{print $8}' <<<$buffer)

    line=${app##*.},${size%%.*},${branch},${l1i_p},${l1d_p},${l2_p},${llc_p},${llc_repl},

    # GENERAL INFO

    buffer=$(grep "CPU 0 cumulative" $file)
    insts=$(awk '{print $7}' <<<$buffer)
    cycles=$(awk '{print $9}' <<<$buffer)
    ipc=$(awk '{print $5}' <<<$buffer)

    line+=${insts},${cycles},${ipc},

    # LEVEL 1 INST

    buffer=$(grep "L1I TOTAL" $file)
    l1i_hit=$(awk '{print $6}' <<<$buffer)
    l1i_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1i_hit},${l1i_miss},

    buffer=$(grep "L1I PREFETCH  REQUESTED:" $file)
    l1i_iss=$(awk '{print $6}' <<<$buffer)
    l1i_usef=$(awk '{print $8}' <<<$buffer)
    l1i_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1i_iss},${l1i_usef},${l1i_less},

    buffer=$(grep "L1I AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 1 DATA

    buffer=$(grep "L1D TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L1D PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L1D AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 2 CACHE

    buffer=$(grep "L2C TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L2C PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L2C AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LAST LEVEL CACHE

    buffer=$(grep "LLC TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "LLC PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "LLC AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # BRANCH PREDICTION

    buffer=$(grep "CPU 0 Branch Prediction" $file)

    branch_acc=$(awk '{print $6}' <<<$buffer | tr -d '%')
    mpki=$(awk '{print $8}' <<<$buffer)

    line+=${branch_acc},${mpki},

    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_JUMP:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_CONDITIONAL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_RETURN:" $file) | tr -d '%')

    echo $line >> $OUT_FILE
    echo "finished this line, yay!"
done

echo "i'm done!"
#+end_src

#+RESULTS:
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: i'm done!

*** Analysis

In order to compare both base and these results, we gotta join them...

#+begin_src R :session :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)

df_b <- read_csv("../results_base/base_results.csv")
df_s <- read_csv("../results_stream/stream_results.csv") %>%
  mutate(config = "Própria")

basic <- df_b %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples")

medium <- df_b %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana")

adv <- df_b %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada")

df_b <- bind_rows(basic, medium, adv)

df <- bind_rows(df_b, df_s)
#+end_src

#+RESULTS:
#+begin_example

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.
#+end_example

Starting with IPC

#+begin_src R :session :results output graphics :file images/stream/ipc.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df %>%
  select(application, config, ipc) %>%
  ggplot(aes(fill = as.factor(config), y = ipc, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Instruções Por Ciclo",
       fill = "Configuração",
       title = "IPC conforme configuração",
       subtitle = "para o terceiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream/ipc.png]]

and by hand MPKI

#+begin_src R :session :results output graphics :file images/stream/mpki_hand.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df %>%
  select(application, config, l1d_tot_miss, inst) %>%
  mutate(mpki = l1d_tot_miss / (inst / 1000)) %>%
  ggplot(aes(fill = as.factor(config), y = mpki, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "MPKI",
       fill = "Configuração",
       title = "MPKI conforme configuração",
       subtitle = "na L1D para o terceiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream/mpki_hand.png]]

Now some hit and misses metrics for L1D:

#+begin_src R :session :results output graphics :file images/stream/hitmiss_l1d.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit) %>%
  mutate(stat = "Hit", l1d_tot_hit = l1d_tot_hit / 1000000) %>%
  rename(value = l1d_tot_hit) -> dfh

df %>%
  select(application, config, l1d_tot_miss) %>%
  mutate(stat = "Miss", l1d_tot_miss = l1d_tot_miss / 1000000) %>%
  rename(value = l1d_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

df2$config <- factor(df2$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df2 %>%
  ggplot(aes(fill = as.factor(config), y = value, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Configuração",
       title = "Acessos à cache nível 1 de dados",
       subtitle = "conforme hit ou miss para o terceiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream/hitmiss_l1d.png]]

And relative misses...

#+begin_src R :session :results output graphics :file images/stream/relmiss_l1d.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit, l1d_tot_miss) %>%
  mutate(stat = "L1D", value = l1d_tot_miss / l1d_tot_hit) %>%
  select(application, config, stat, value) -> df2

df2$config <- factor(df2$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df2 %>%
  ggplot(aes(fill = config, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L1D",
       subtitle = "para o terceiro experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream/relmiss_l1d.png]]

** 4 - Greedier Data Prefetcher

Even more data when fetching.

*** Preprocessing

Again, a script...

#+begin_src bash :exports both :results output :dir ../results_stream_l1d/
OUT_FILE=true_stream_results.csv

echo "application,size,branch,l1i_pref,l1d_pref,l2c_pref,llc_pref,llc_rep,inst,cycles,ipc"\
     "l1i_tot_hit,l1i_tot_miss,l1i_pref_issued,l1i_pref_useful,l1i_pref_useless,l1i_lat"\
     "l1d_tot_hit,l1d_tot_miss,l1d_pref_issued,l1d_pref_useful,l1d_pref_useless,l1d_lat"\
     "l2c_tot_hit,l2c_tot_miss,l2c_pref_issued,l2c_pref_useful,l2c_pref_useless,l2c_lat"\
     "llc_tot_hit,llc_tot_miss,llc_pref_issued,llc_pref_useful,llc_pref_useless,llc_lat"\
     "branch_acc,mpki"\
     "branch_direct,branch_indirect,branch_cond,branch_dir_call,branch_ind_call,branch_ret" | tr ' ' ',' > $OUT_FILE

for file in [0-9]*; do
    # INFO ABOUT CONFIG

    buffer=$(tr '-' ' ' <<<$file)

    app=$(awk '{print $1}' <<<$buffer)
    size=$(awk '{print $2}' <<<$buffer)
    branch=$(awk '{print $3}' <<<$buffer)
    l1i_p=$(awk '{print $4}' <<<$buffer)
    l1d_p=$(awk '{print $5}' <<<$buffer)
    l2_p=$(awk '{print $6}' <<<$buffer)
    llc_p=$(awk '{print $7}' <<<$buffer)
    llc_repl=$(awk '{print $8}' <<<$buffer)

    line=${app##*.},${size%%.*},${branch},${l1i_p},${l1d_p},${l2_p},${llc_p},${llc_repl},

    # GENERAL INFO

    buffer=$(grep "CPU 0 cumulative" $file)
    insts=$(awk '{print $7}' <<<$buffer)
    cycles=$(awk '{print $9}' <<<$buffer)
    ipc=$(awk '{print $5}' <<<$buffer)

    line+=${insts},${cycles},${ipc},

    # LEVEL 1 INST

    buffer=$(grep "L1I TOTAL" $file)
    l1i_hit=$(awk '{print $6}' <<<$buffer)
    l1i_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1i_hit},${l1i_miss},

    buffer=$(grep "L1I PREFETCH  REQUESTED:" $file)
    l1i_iss=$(awk '{print $6}' <<<$buffer)
    l1i_usef=$(awk '{print $8}' <<<$buffer)
    l1i_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1i_iss},${l1i_usef},${l1i_less},

    buffer=$(grep "L1I AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 1 DATA

    buffer=$(grep "L1D TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L1D PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L1D AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 2 CACHE

    buffer=$(grep "L2C TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L2C PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L2C AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LAST LEVEL CACHE

    buffer=$(grep "LLC TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "LLC PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "LLC AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # BRANCH PREDICTION

    buffer=$(grep "CPU 0 Branch Prediction" $file)

    branch_acc=$(awk '{print $6}' <<<$buffer | tr -d '%')
    mpki=$(awk '{print $8}' <<<$buffer)

    line+=${branch_acc},${mpki},

    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_JUMP:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_CONDITIONAL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_RETURN:" $file) | tr -d '%')

    echo $line >> $OUT_FILE
    echo "finished this line, yay!"
done

echo "i'm done!"
#+end_src

#+RESULTS:
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: finished this line, yay!
: i'm done!

*** Analysis

Let's start by uniting both base and own results...

#+begin_src R :session :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)

df_b <- read_csv("../results_base/base_results.csv")
df_t <- read_csv("../results_stream_l1d/true_stream_results.csv") %>%
  mutate(config = "Própria")

basic <- df_b %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples")

medium <- df_b %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana")

adv <- df_b %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada")

df_b <- bind_rows(basic, medium, adv)

df <- bind_rows(df_b, df_t)
#+end_src

#+RESULTS:
#+begin_example

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.
#+end_example

And now let's take the already done EXP03 graphs.

#+begin_src R :session :results output graphics :file images/true_stream/ipc.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df %>%
  select(application, config, ipc) %>%
  ggplot(aes(fill = as.factor(config), y = ipc, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Instruções Por Ciclo",
       fill = "Configuração",
       title = "IPC conforme configuração",
       subtitle = "para o quarto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/true_stream/ipc.png]]

Now, let's do MPKI by hand (for L1D):

#+begin_src R :session :results output graphics :file images/true_stream/mpki_hand.png :exports both :width 800 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df %>%
  select(application, config, l1d_tot_miss, inst) %>%
  mutate(mpki = l1d_tot_miss / (inst / 1000)) %>%
  ggplot(aes(fill = as.factor(config), y = mpki, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "MPKI",
       fill = "Configuração",
       title = "MPKI conforme configuração",
       subtitle = "na L1D para o quarto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/true_stream/mpki_hand.png]]

Now some hit and misses metrics for L1D:

#+begin_src R :session :results output graphics :file images/true_stream/hitmiss_l1d.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit) %>%
  mutate(stat = "Hit", l1d_tot_hit = l1d_tot_hit / 1000000) %>%
  rename(value = l1d_tot_hit) -> dfh

df %>%
  select(application, config, l1d_tot_miss) %>%
  mutate(stat = "Miss", l1d_tot_miss = l1d_tot_miss / 1000000) %>%
  rename(value = l1d_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

df2$config <- factor(df2$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df2 %>%
  ggplot(aes(fill = as.factor(config), y = value, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Configuração",
       title = "Acessos à cache nível 1 de dados",
       subtitle = "conforme hit ou miss para o quarto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/true_stream/hitmiss_l1d.png]]

And relative misses...

#+begin_src R :session :results output graphics :file images/true_stream/relmiss_l1d.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit, l1d_tot_miss) %>%
  mutate(stat = "L1D", value = l1d_tot_miss / l1d_tot_hit) %>%
  select(application, config, stat, value) -> df2

df2$config <- factor(df2$config, levels = c("Simples", "Mediana", "Avançada", "Própria"))

df2 %>%
  ggplot(aes(fill = config, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 4, name = "GrandBudapest1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L1D",
       subtitle = "para o quarto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/true_stream/relmiss_l1d.png]]

** 5 - 64 lines L1D Prefetcher

*** Preprocessing

First we gotta get that into a friendlier CSV format...

#+begin_src bash :exports both :results output :dir ../results_stream_l1d_64/
OUT_FILE=stream64_results.csv

echo "application,size,branch,l1i_pref,l1d_pref,l2c_pref,llc_pref,llc_rep,inst,cycles,ipc"\
     "l1i_tot_hit,l1i_tot_miss,l1i_pref_issued,l1i_pref_useful,l1i_pref_useless,l1i_lat"\
     "l1d_tot_hit,l1d_tot_miss,l1d_pref_issued,l1d_pref_useful,l1d_pref_useless,l1d_lat"\
     "l2c_tot_hit,l2c_tot_miss,l2c_pref_issued,l2c_pref_useful,l2c_pref_useless,l2c_lat"\
     "llc_tot_hit,llc_tot_miss,llc_pref_issued,llc_pref_useful,llc_pref_useless,llc_lat"\
     "branch_acc,mpki"\
     "branch_direct,branch_indirect,branch_cond,branch_dir_call,branch_ind_call,branch_ret" | tr ' ' ',' > $OUT_FILE

for file in [0-9]*; do
    # INFO ABOUT CONFIG

    buffer=$(tr '-' ' ' <<<$file)

    app=$(awk '{print $1}' <<<$buffer)
    size=$(awk '{print $2}' <<<$buffer)
    branch=$(awk '{print $3}' <<<$buffer)
    l1i_p=$(awk '{print $4}' <<<$buffer)
    l1d_p=$(awk '{print $5}' <<<$buffer)
    l2_p=$(awk '{print $6}' <<<$buffer)
    llc_p=$(awk '{print $7}' <<<$buffer)
    llc_repl=$(awk '{print $8}' <<<$buffer)

    line=${app##*.},${size%%.*},${branch},${l1i_p},${l1d_p},${l2_p},${llc_p},${llc_repl},

    # GENERAL INFO

    buffer=$(grep "CPU 0 cumulative" $file)
    insts=$(awk '{print $7}' <<<$buffer)
    cycles=$(awk '{print $9}' <<<$buffer)
    ipc=$(awk '{print $5}' <<<$buffer)

    line+=${insts},${cycles},${ipc},

    # LEVEL 1 INST

    buffer=$(grep "L1I TOTAL" $file)
    l1i_hit=$(awk '{print $6}' <<<$buffer)
    l1i_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1i_hit},${l1i_miss},

    buffer=$(grep "L1I PREFETCH  REQUESTED:" $file)
    l1i_iss=$(awk '{print $6}' <<<$buffer)
    l1i_usef=$(awk '{print $8}' <<<$buffer)
    l1i_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1i_iss},${l1i_usef},${l1i_less},

    buffer=$(grep "L1I AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 1 DATA

    buffer=$(grep "L1D TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L1D PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L1D AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 2 CACHE

    buffer=$(grep "L2C TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L2C PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L2C AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LAST LEVEL CACHE

    buffer=$(grep "LLC TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "LLC PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "LLC AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # BRANCH PREDICTION

    buffer=$(grep "CPU 0 Branch Prediction" $file)

    branch_acc=$(awk '{print $6}' <<<$buffer | tr -d '%')
    mpki=$(awk '{print $8}' <<<$buffer)

    line+=${branch_acc},${mpki},

    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_JUMP:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_CONDITIONAL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_RETURN:" $file) | tr -d '%')

    echo $line >> $OUT_FILE
    echo "finished this line, yay!"
done

echo "i'm done!"
#+end_src

#+RESULTS:
#+begin_example
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
i'm done!
#+end_example

*** Analysis

In order to compare both base and these results, we gotta join them...

#+begin_src R :session :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)

df_b <- read_csv("../results_base/base_results.csv")
df_s <- read_csv("../results_stream_l1d_64/stream64_results.csv")

basic <- df_b %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples")

medium <- df_b %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana")

adv <- df_b %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada")

basic_m <- df_s %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples - mod")

medium_m <- df_s %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana - mod")

adv_m <- df_s %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada - mod")

df_b <- bind_rows(basic, medium, adv)
df_s <- bind_rows(basic_m, medium_m, adv_m)

df <- bind_rows(df_b, df_s)
#+end_src

#+RESULTS:
#+begin_example

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.
#+end_example

Starting with IPC

#+begin_src R :session :results output graphics :file images/stream64/ipc.png :exports both :width 850 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df %>%
  select(application, config, ipc) %>%
  ggplot(aes(fill = as.factor(config), y = ipc, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Instruções Por Ciclo",
       fill = "Configuração",
       title = "IPC conforme configuração",
       subtitle = "para o quinto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream64/ipc.png]]

and by hand MPKI

#+begin_src R :session :results output graphics :file images/stream64/mpki_hand.png :exports both :width 850 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df %>%
  select(application, config, l1d_tot_miss, inst) %>%
  mutate(mpki = l1d_tot_miss / (inst / 1000)) %>%
  ggplot(aes(fill = as.factor(config), y = mpki, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "MPKI",
       fill = "Configuração",
       title = "MPKI conforme configuração",
       subtitle = "na L1D para o quinto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream64/mpki_hand.png]]

Now some hit and misses metrics for L1D:

#+begin_src R :session :results output graphics :file images/stream64/hitmiss_l1d.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit) %>%
  mutate(stat = "Hit", l1d_tot_hit = l1d_tot_hit / 1000000) %>%
  rename(value = l1d_tot_hit) -> dfh

df %>%
  select(application, config, l1d_tot_miss) %>%
  mutate(stat = "Miss", l1d_tot_miss = l1d_tot_miss / 1000000) %>%
  rename(value = l1d_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

df2$config <- factor(df2$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df2 %>%
  ggplot(aes(fill = as.factor(config), y = value, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Configuração",
       title = "Acessos à cache nível 1 de dados",
       subtitle = "conforme hit ou miss para o quinto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream64/hitmiss_l1d.png]]

And relative misses...

#+begin_src R :session :results output graphics :file images/stream64/relmiss_l1d.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit, l1d_tot_miss) %>%
  mutate(stat = "L1D", value = l1d_tot_miss / l1d_tot_hit) %>%
  select(application, config, stat, value) -> df2

df2$config <- factor(df2$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df2 %>%
  ggplot(aes(fill = config, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L1D",
       subtitle = "para o quinto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream64/relmiss_l1d.png]]

** 6 - Stream on Instructions

*** Preprocessing

Again, a script...

#+begin_src bash :exports both :results output :dir ../results_stream_l1i/
OUT_FILE=stream_inst_results.csv

echo "application,size,branch,l1i_pref,l1d_pref,l2c_pref,llc_pref,llc_rep,inst,cycles,ipc"\
     "l1i_tot_hit,l1i_tot_miss,l1i_pref_issued,l1i_pref_useful,l1i_pref_useless,l1i_lat"\
     "l1d_tot_hit,l1d_tot_miss,l1d_pref_issued,l1d_pref_useful,l1d_pref_useless,l1d_lat"\
     "l2c_tot_hit,l2c_tot_miss,l2c_pref_issued,l2c_pref_useful,l2c_pref_useless,l2c_lat"\
     "llc_tot_hit,llc_tot_miss,llc_pref_issued,llc_pref_useful,llc_pref_useless,llc_lat"\
     "branch_acc,mpki"\
     "branch_direct,branch_indirect,branch_cond,branch_dir_call,branch_ind_call,branch_ret" | tr ' ' ',' > $OUT_FILE

for file in [0-9]*; do
    # INFO ABOUT CONFIG

    buffer=$(tr '-' ' ' <<<$file)

    app=$(awk '{print $1}' <<<$buffer)
    size=$(awk '{print $2}' <<<$buffer)
    branch=$(awk '{print $3}' <<<$buffer)
    l1i_p=$(awk '{print $4}' <<<$buffer)
    l1d_p=$(awk '{print $5}' <<<$buffer)
    l2_p=$(awk '{print $6}' <<<$buffer)
    llc_p=$(awk '{print $7}' <<<$buffer)
    llc_repl=$(awk '{print $8}' <<<$buffer)

    line=${app##*.},${size%%.*},${branch},${l1i_p},${l1d_p},${l2_p},${llc_p},${llc_repl},

    # GENERAL INFO

    buffer=$(grep "CPU 0 cumulative" $file)
    insts=$(awk '{print $7}' <<<$buffer)
    cycles=$(awk '{print $9}' <<<$buffer)
    ipc=$(awk '{print $5}' <<<$buffer)

    line+=${insts},${cycles},${ipc},

    # LEVEL 1 INST

    buffer=$(grep "L1I TOTAL" $file)
    l1i_hit=$(awk '{print $6}' <<<$buffer)
    l1i_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1i_hit},${l1i_miss},

    buffer=$(grep "L1I PREFETCH  REQUESTED:" $file)
    l1i_iss=$(awk '{print $6}' <<<$buffer)
    l1i_usef=$(awk '{print $8}' <<<$buffer)
    l1i_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1i_iss},${l1i_usef},${l1i_less},

    buffer=$(grep "L1I AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 1 DATA

    buffer=$(grep "L1D TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L1D PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L1D AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 2 CACHE

    buffer=$(grep "L2C TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L2C PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L2C AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LAST LEVEL CACHE

    buffer=$(grep "LLC TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "LLC PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "LLC AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # BRANCH PREDICTION

    buffer=$(grep "CPU 0 Branch Prediction" $file)

    branch_acc=$(awk '{print $6}' <<<$buffer | tr -d '%')
    mpki=$(awk '{print $8}' <<<$buffer)

    line+=${branch_acc},${mpki},

    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_JUMP:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_CONDITIONAL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_RETURN:" $file) | tr -d '%')

    echo $line >> $OUT_FILE
    echo "finished this line, yay!"
done

echo "i'm done!"
#+end_src

#+RESULTS:
#+begin_example
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
i'm done!
#+end_example

*** Analysis

Let's start by uniting both base and own results...

#+begin_src R :session :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)

df_b <- read_csv("../results_base/base_results.csv")
df_s <- read_csv("../results_stream_l1i/stream_inst_results.csv")

basic <- df_b %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples")

medium <- df_b %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana")

adv <- df_b %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada")

basic_m <- df_s %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples - mod")

medium_m <- df_s %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana - mod")

adv_m <- df_s %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada - mod")

df_b <- bind_rows(basic, medium, adv)
df_s <- bind_rows(basic_m, medium_m, adv_m)

df <- bind_rows(df_b, df_s)
#+end_src

#+RESULTS:
#+begin_example

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.
#+end_example

And now let's take the already done EXP03 graphs.

#+begin_src R :session :results output graphics :file images/stream_l1i/ipc.png :exports both :width 850 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df %>%
  select(application, config, ipc) %>%
  ggplot(aes(fill = as.factor(config), y = ipc, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Instruções Por Ciclo",
       fill = "Configuração",
       title = "IPC conforme configuração",
       subtitle = "para o sexto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream_l1i/ipc.png]]

Now, let's do MPKI by hand (for L1I):

#+begin_src R :session :results output graphics :file images/stream_l1i/mpki_hand.png :exports both :width 850 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df %>%
  select(application, config, l1i_tot_miss, inst) %>%
  mutate(mpki = l1i_tot_miss / (inst / 1000)) %>%
  ggplot(aes(fill = as.factor(config), y = mpki, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "MPKI",
       fill = "Configuração",
       title = "MPKI conforme configuração",
       subtitle = "na L1I para o sexto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream_l1i/mpki_hand.png]]

Now some hit and misses metrics for L1I:

#+begin_src R :session :results output graphics :file images/stream_l1i/hitmiss_l1i.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1i_tot_hit) %>%
  mutate(stat = "Hit", l1i_tot_hit = l1i_tot_hit / 1000000) %>%
  rename(value = l1i_tot_hit) -> dfh

df %>%
  select(application, config, l1i_tot_miss) %>%
  mutate(stat = "Miss", l1i_tot_miss = l1i_tot_miss / 1000000) %>%
  rename(value = l1i_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

df2$config <- factor(df2$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df2 %>%
  ggplot(aes(fill = as.factor(config), y = value, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Configuração",
       title = "Acessos à cache nível 1 de instruções",
       subtitle = "conforme hit ou miss para o sexto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream_l1i/hitmiss_l1i.png]]

And relative misses...

#+begin_src R :session :results output graphics :file images/stream_l1i/relmiss_l1i.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1i_tot_hit, l1i_tot_miss) %>%
  mutate(stat = "L1I", value = l1i_tot_miss / l1i_tot_hit) %>%
  select(application, config, stat, value) -> df2

df2$config <- factor(df2$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df2 %>%
  ggplot(aes(fill = config, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L1I",
       subtitle = "para o sexto experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream_l1i/relmiss_l1i.png]]

** 7 - 32 line L1D Prefetcher

*** Preprocessing

First we gotta get that into a friendlier CSV format...

#+begin_src bash :exports both :results output :dir ../results_stream_l1d_32/
OUT_FILE=stream32_results.csv

echo "application,size,branch,l1i_pref,l1d_pref,l2c_pref,llc_pref,llc_rep,inst,cycles,ipc"\
     "l1i_tot_hit,l1i_tot_miss,l1i_pref_issued,l1i_pref_useful,l1i_pref_useless,l1i_lat"\
     "l1d_tot_hit,l1d_tot_miss,l1d_pref_issued,l1d_pref_useful,l1d_pref_useless,l1d_lat"\
     "l2c_tot_hit,l2c_tot_miss,l2c_pref_issued,l2c_pref_useful,l2c_pref_useless,l2c_lat"\
     "llc_tot_hit,llc_tot_miss,llc_pref_issued,llc_pref_useful,llc_pref_useless,llc_lat"\
     "branch_acc,mpki"\
     "branch_direct,branch_indirect,branch_cond,branch_dir_call,branch_ind_call,branch_ret" | tr ' ' ',' > $OUT_FILE

for file in [0-9]*; do
    # INFO ABOUT CONFIG

    buffer=$(tr '-' ' ' <<<$file)

    app=$(awk '{print $1}' <<<$buffer)
    size=$(awk '{print $2}' <<<$buffer)
    branch=$(awk '{print $3}' <<<$buffer)
    l1i_p=$(awk '{print $4}' <<<$buffer)
    l1d_p=$(awk '{print $5}' <<<$buffer)
    l2_p=$(awk '{print $6}' <<<$buffer)
    llc_p=$(awk '{print $7}' <<<$buffer)
    llc_repl=$(awk '{print $8}' <<<$buffer)

    line=${app##*.},${size%%.*},${branch},${l1i_p},${l1d_p},${l2_p},${llc_p},${llc_repl},

    # GENERAL INFO

    buffer=$(grep "CPU 0 cumulative" $file)
    insts=$(awk '{print $7}' <<<$buffer)
    cycles=$(awk '{print $9}' <<<$buffer)
    ipc=$(awk '{print $5}' <<<$buffer)

    line+=${insts},${cycles},${ipc},

    # LEVEL 1 INST

    buffer=$(grep "L1I TOTAL" $file)
    l1i_hit=$(awk '{print $6}' <<<$buffer)
    l1i_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1i_hit},${l1i_miss},

    buffer=$(grep "L1I PREFETCH  REQUESTED:" $file)
    l1i_iss=$(awk '{print $6}' <<<$buffer)
    l1i_usef=$(awk '{print $8}' <<<$buffer)
    l1i_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1i_iss},${l1i_usef},${l1i_less},

    buffer=$(grep "L1I AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 1 DATA

    buffer=$(grep "L1D TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L1D PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L1D AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LEVEL 2 CACHE

    buffer=$(grep "L2C TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "L2C PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "L2C AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # LAST LEVEL CACHE

    buffer=$(grep "LLC TOTAL" $file)
    l1d_hit=$(awk '{print $6}' <<<$buffer)
    l1d_miss=$(awk '{print $8}' <<<$buffer)

    line+=${l1d_hit},${l1d_miss},

    buffer=$(grep "LLC PREFETCH  REQUESTED:" $file)
    l1d_iss=$(awk '{print $6}' <<<$buffer)
    l1d_usef=$(awk '{print $8}' <<<$buffer)
    l1d_less=$(awk '{print $10}' <<<$buffer)

    line+=${l1d_iss},${l1d_usef},${l1d_less},

    buffer=$(grep "LLC AVERAGE MISS" $file | tr -d '-')

    line+=$(awk '{print $5}' <<<$buffer),

    # BRANCH PREDICTION

    buffer=$(grep "CPU 0 Branch Prediction" $file)

    branch_acc=$(awk '{print $6}' <<<$buffer | tr -d '%')
    mpki=$(awk '{print $8}' <<<$buffer)

    line+=${branch_acc},${mpki},

    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_JUMP:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_CONDITIONAL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_DIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_INDIRECT_CALL:" $file) | tr -d '%'),
    line+=$(awk '{print $3}' <<<$(grep "BRANCH_RETURN:" $file) | tr -d '%')

    echo $line >> $OUT_FILE
    echo "finished this line, yay!"
done

echo "i'm done!"
#+end_src

#+RESULTS:
#+begin_example
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
finished this line, yay!
i'm done!
#+end_example

*** Analysis

In order to compare both base and these results, we gotta join them...

#+begin_src R :session :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)

df_b <- read_csv("../results_base/base_results.csv")
df_s <- read_csv("../results_stream_l1d_32/stream32_results.csv")

basic <- df_b %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples")

medium <- df_b %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana")

adv <- df_b %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada")

basic_m <- df_s %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples - mod")

medium_m <- df_s %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana - mod")

adv_m <- df_s %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada - mod")

df_b <- bind_rows(basic, medium, adv)
df_s <- bind_rows(basic_m, medium_m, adv_m)

df <- bind_rows(df_b, df_s)
#+end_src

#+RESULTS:
#+begin_example

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.

Parsed with column specification:
cols(
  .default = col_double(),
  application = col_character(),
  size = col_character(),
  branch = col_character(),
  l1i_pref = col_character(),
  l1d_pref = col_character(),
  l2c_pref = col_character(),
  llc_pref = col_character(),
  llc_rep = col_character()
)
See spec(...) for full column specifications.
#+end_example

Starting with IPC

#+begin_src R :session :results output graphics :file images/stream32/ipc.png :exports both :width 850 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df %>%
  select(application, config, ipc) %>%
  ggplot(aes(fill = as.factor(config), y = ipc, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Instruções Por Ciclo",
       fill = "Configuração",
       title = "IPC conforme configuração",
       subtitle = "para o sétimo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream32/ipc.png]]

and by hand MPKI

#+begin_src R :session :results output graphics :file images/stream32/mpki_hand.png :exports both :width 850 :height 700
suppressMessages(library(wesanderson))

df$config <- factor(df$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df %>%
  select(application, config, l1d_tot_miss, inst) %>%
  mutate(mpki = l1d_tot_miss / (inst / 1000)) %>%
  ggplot(aes(fill = as.factor(config), y = mpki, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "MPKI",
       fill = "Configuração",
       title = "MPKI conforme configuração",
       subtitle = "na L1D para o sétimo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream32/mpki_hand.png]]

Now some hit and misses metrics for L1D:

#+begin_src R :session :results output graphics :file images/stream32/hitmiss_l1d.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit) %>%
  mutate(stat = "Hit", l1d_tot_hit = l1d_tot_hit / 1000000) %>%
  rename(value = l1d_tot_hit) -> dfh

df %>%
  select(application, config, l1d_tot_miss) %>%
  mutate(stat = "Miss", l1d_tot_miss = l1d_tot_miss / 1000000) %>%
  rename(value = l1d_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

df2$config <- factor(df2$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df2 %>%
  ggplot(aes(fill = as.factor(config), y = value, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Configuração",
       title = "Acessos à cache nível 1 de dados",
       subtitle = "conforme hit ou miss para o sétimo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream32/hitmiss_l1d.png]]

And relative misses...

#+begin_src R :session :results output graphics :file images/stream32/relmiss_l1d.png :exports both :width 900 :height 600
suppressMessages(library(wesanderson))

df %>%
  select(application, config, l1d_tot_hit, l1d_tot_miss) %>%
  mutate(stat = "L1D", value = l1d_tot_miss / l1d_tot_hit) %>%
  select(application, config, stat, value) -> df2

df2$config <- factor(df2$config, levels = c("Simples", "Simples - mod", "Mediana", "Mediana - mod", "Avançada", "Avançada - mod"))

df2 %>%
  ggplot(aes(fill = config, y = value, x = application)) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  labs(x = "Aplicação",
       y = "Misses / Hits",
       fill = "Configuração",
       title = "Misses relativos na L1D",
       subtitle = "para o sétimo experimento") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream32/relmiss_l1d.png]]

Let's do something harder and compare our implementations:

#+begin_src R :session :results output graphics :file images/stream32/hitmiss_comp_l1d.png :exports both :width 1000 :height 900
suppressMessages(library(wesanderson))

df_b <- read_csv("../results_stream_l1d_64/stream64_results.csv")
df_s <- read_csv("../results_stream_l1d_32/stream32_results.csv")

basic <- df_b %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples - 64")

medium <- df_b %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana - 64")

adv <- df_b %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada - 64")

basic_m <- df_s %>%
  filter(l2c_pref == "no") %>%
  mutate(config = "Simples - 32")

medium_m <- df_s %>%
  filter(l2c_pref == "ip_stride") %>%
  mutate(config = "Mediana - 32")

adv_m <- df_s %>%
  filter(l2c_pref == "kpcp") %>%
  mutate(config = "Avançada - 32")

df_b <- bind_rows(basic, medium, adv)
df_s <- bind_rows(basic_m, medium_m, adv_m)

df <- bind_rows(df_b, df_s)

df %>%
  select(application, config, l1d_tot_hit) %>%
  mutate(stat = "Hit", l1d_tot_hit = l1d_tot_hit / 1000000) %>%
  rename(value = l1d_tot_hit) -> dfh

df %>%
  select(application, config, l1d_tot_miss) %>%
  mutate(stat = "Miss", l1d_tot_miss = l1d_tot_miss / 1000000) %>%
  rename(value = l1d_tot_miss) -> dfm

df2 <- bind_rows(dfh, dfm)

df2$config <- factor(df2$config, levels = c("Simples - 64", "Simples - 32", "Mediana - 64", "Mediana - 32", "Avançada - 64", "Avançada - 32"))

df2 %>%
  ggplot(aes(fill = as.factor(config), y = value, x = as.factor(application))) +
  geom_col(position = "dodge2", width = 0.6, color = "black") +
  scale_fill_manual(values = wes_palette(n = 6, name = "IsleofDogs1")) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.03)),
                     breaks = scales::pretty_breaks(n = 8)) +
  facet_grid(stat ~ .) +
  labs(x = "Aplicação",
       y = "Quantidade [x10^6]",
       fill = "Configuração",
       title = "Acessos à cache nível 1 de dados",
       subtitle = "conforme hit ou miss comparando os sétimo e quinto experimentos") +
  theme_bw() +
  theme(text = element_text(family = "Palatino", size = 28),
        panel.spacing = unit(2, "lines"),
        legend.position = "top")
#+end_src

#+RESULTS:
[[file:images/stream32/hitmiss_comp_l1d.png]]
